//
// Created by root on 06.02.20.
//

#ifndef BP_FILTER_H
#define BP_FILTER_H

#include "structures.h"
#include "sharedMemory/SHMRawRead.h"
#include "sharedMemory/SHMAggregationWrite.h"
#include "Logger/Logger.h"
extern "C"{
#include "filter/arm_fir_decimate.h"
}
#include <iostream>
#include <fstream>
#include <string>
#include "TCPClient.h"
class Filter {
public:
    Filter(Config config);
    ~Filter();
    void initialize();
    void start();
private:
    Config config;
    q31_t *channelBlocks;

    arm_fir_decimate_instance_q31 firInstance[4];
    int32_t rawCounter;

    q31_t *pState[NUMBER_OF_SENSORS];
    uint8_t M = 16;
    uint32_t blockSize;

    q31_t *outputData;

    const uint16_t num_taps = 385;

    int32_t P_COEFFS[385] = {
            -119786,      -25193,      -24805,      -21950,      -16200,       -7143,
            5603,       22364,       43394,       68851,       98782,      133102,
            171580,      213831,      259304,      307282,      356883,      407068,
            456655,      504340,      548721,      588330,      621670,      647256,
            663659,      669554,      663767,      645325,      613503,      567866,
            508308,      435083,      348833,      250598,      141823,       24353,
            -99591,     -227442,     -356330,     -483137,     -604572,     -717242,
            -817740,     -902744,     -969108,    -1013965,    -1034829,    -1029684,
            -997077,     -936195,     -846931,     -729933,     -586634,     -419269,
            -230859,      -25179,      193295,      419470,      647739,      872100,
            1086301,     1283998,     1458922,     1605059,     1716829,     1789270,
            1818203,     1800400,     1733723,     1617246,     1451350,     1237784,
            979693,      681609,      349405,       -9801,     -387767,     -775297,
            -1162442,    -1538734,    -1893448,    -2215881,    -2495649,    -2722987,
            -2889054,    -2986218,    -3008331,    -2950975,    -2811667,    -2590029,
            -2287904,    -1909415,    -1460969,     -951197,     -390822,      207523,
            829550,     1459624,     2081123,     2676842,     3229439,     3721891,
            4137983,     4462779,     4683097,     4787945,     4768929,     4620600,
            4340747,     3930608,     3394997,     2742353,     1984672,     1137361,
            218977,     -749120,    -1743212,    -2737749,    -3705947,    -4620453,
            -5454045,    -6180372,    -6774695,    -7214629,    -7480845,    -7557732,
            -7433988,    -7103123,    -6563859,    -5820413,    -4882647,    -3766077,
            -2491734,    -1085879,      420434,     1991941,     3589880,     5172833,
            6697667,     8120571,     9398150,    10488560,    11352666,    11955166,
            12265693,    12259827,    11920019,    11236379,    10207322,     8840039,
            7150771,     5164894,     2916780,      449441,    -2186033,    -4931261,
            -7721546,   -10487038,   -13154061,   -15646574,   -17887741,   -19801575,
            -21314625,   -22357661,   -22867327,   -22787721,   -22071860,   -20683003,
            -18595790,   -15797177,   -12287128,    -8079061,    -3200014,     2309465,
            8395711,    14992621,    22022597,    29397753,    37021351,    44789441,
            52592690,    60318333,    67852232,    75080993,    81894090,    88185962,
            93858027,    98820581,   102994538,   106312963,   108722385,   110183841,
            110673642,   110183841,   108722385,   106312963,   102994538,    98820581,
            93858027,    88185962,    81894090,    75080993,    67852232,    60318333,
            52592690,    44789441,    37021351,    29397753,    22022597,    14992621,
            8395711,     2309465,    -3200014,    -8079061,   -12287128,   -15797177,
            -18595790,   -20683003,   -22071860,   -22787721,   -22867327,   -22357661,
            -21314625,   -19801575,   -17887741,   -15646574,   -13154061,   -10487038,
            -7721546,    -4931261,    -2186033,      449441,     2916780,     5164894,
            7150771,     8840039,    10207322,    11236379,    11920019,    12259827,
            12265693,    11955166,    11352666,    10488560,     9398150,     8120571,
            6697667,     5172833,     3589880,     1991941,      420434,    -1085879,
            -2491734,    -3766077,    -4882647,    -5820413,    -6563859,    -7103123,
            -7433988,    -7557732,    -7480845,    -7214629,    -6774695,    -6180372,
            -5454045,    -4620453,    -3705947,    -2737749,    -1743212,     -749120,
            218977,     1137361,     1984672,     2742353,     3394997,     3930608,
            4340747,     4620600,     4768929,     4787945,     4683097,     4462779,
            4137983,     3721891,     3229439,     2676842,     2081123,     1459624,
            829550,      207523,     -390822,     -951197,    -1460969,    -1909415,
            -2287904,    -2590029,    -2811667,    -2950975,    -3008331,    -2986218,
            -2889054,    -2722987,    -2495649,    -2215881,    -1893448,    -1538734,
            -1162442,     -775297,     -387767,       -9801,      349405,      681609,
            979693,     1237784,     1451350,     1617246,     1733723,     1800400,
            1818203,     1789270,     1716829,     1605059,     1458922,     1283998,
            1086301,      872100,      647739,      419470,      193295,      -25179,
            -230859,     -419269,     -586634,     -729933,     -846931,     -936195,
            -997077,    -1029684,    -1034829,    -1013965,     -969108,     -902744,
            -817740,     -717242,     -604572,     -483137,     -356330,     -227442,
            -99591,       24353,      141823,      250598,      348833,      435083,
            508308,      567866,      613503,      645325,      663767,      669554,
            663659,      647256,      621670,      588330,      548721,      504340,
            456655,      407068,      356883,      307282,      259304,      213831,
            171580,      133102,       98782,       68851,       43394,       22364,
            5603,       -7143,      -16200,      -21950,      -24805,      -25193,
            -119786
    };
};


#endif //BP_FILTER_H

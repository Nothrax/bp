//
// Created by Jakub Trubka on 21.10.19.
//

#ifndef BP_SPI_H
#define BP_SPI_H

#include "../abstractClass/InterfaceReader.h"
#include "Logger/Logger.h"
#include "configReader/Configuration.h"
#include <bcm2835.h>
#include "sharedMemory/SHMRawWrite.h"
//#include <structures.h>

class SPI : public InterfaceReader{
public:
    void setUp() override ;
    void start() override ;
    explicit SPI(Config config);
    ~SPI();

private:
    void restartAdc();
    void initializeSPI();
    void setRegisterSafe(unsigned char *transferRegister, unsigned char *receiveRegister, std::string setupPart);
    void initializeAdc();
    void initializeODPins();
    uint16_t checkCRC(uint8_t *ptr, int count);
    Config config;

    int fd;


    unsigned char default_tx[18]  = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcc, 0x9c, 0x00 };
    unsigned char rreg_tx[18]     = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcc, 0x9c, 0x00 };
    unsigned char unlock_tx[18]   = { 0x06, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    unsigned char unlock_rx[18]   = { 0x06, 0x55 };
    unsigned char adc_ena_tx[18]  = { 0x4f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xed, 0x3e, 0x00 };
    unsigned char adc_ena_rx[18]  = { 0x2f, 0x0f };
    unsigned char wake_up_tx[18]  = { 0x00, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9c, 0x5a, 0x00 };
    unsigned char wake_up_rx[18]  = { 0x00, 0x33 };
    unsigned char lock_com_tx[18] = { 0x05, 0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd6, 0x26, 0x00 };
    unsigned char lock_com_rx[18] = { 0x05, 0x55 };
    unsigned char clk_8k_tx[18]   = { 0x4e, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x23, 0x00 };
    unsigned char clk_8k_rx[18]   = { 0x2e, 0x25 };
    unsigned char clk_64k_tx[18]  = { 0x4e, 0x2d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xba, 0x8a, 0x00 };
    unsigned char clk_64k_rx[18]  = { 0x2e, 0x2d };
    unsigned char clk_128k_tx[18] = { 0x4e, 0x2f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0xe8, 0x00 };
    unsigned char clk_128k_rx[18] = { 0x2e, 0x2e }; //2f?
    unsigned char clk1_tx[18]     = { 0x4d, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xee, 0x9a, 0x00 };
    unsigned char clk1_rx[18]     = { 0x2d, 0x02 };
    unsigned char sysconf_tx[18]  = { 0x4b, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x30, 0x00 };
    unsigned char sysconf_rx[18]  = { 0x2b, 0x78 };
    unsigned char crc_tx[18]      = { 0x4c, 0x2F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    unsigned char crc_rx[18]      = { 0x2c, 0x2F };
    unsigned char reset_tx[18]	  = { 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    unsigned char reset_rx[18]	  = { 0xff, 0x04 };
    unsigned char statp_tx[18]	  = { 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x0a, 0x00 };
    unsigned char statn_tx[18]	  = { 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x96, 0x9a, 0x00 };

    unsigned char default_rx[ARRAY_SIZE(default_tx)] = {0, };
};


#endif //BP_SPI_H
